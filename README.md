# Quadral Cluster Bot v3.0

## Цель проекта и KPI
- **Цель:** ускорить и упростить формирование устойчивых кластеров из четырёх человек на основе соционической и психософской совместимости.
- **KPI:**
  - ≥60% пользователей попадают в кластер в течение 14 дней.
  - Средняя оценка удовлетворённости (CSAT) ≥4.3/5 через 14 дней.
  - Ретеншен активности в кластерах (D30) ≥35%.

## Основные роли
- **Пользователь:** зарегистрирован, имеет профиль и подписку.
- **Участник кластера:** активный член группы.
- **Основатель:** первый создатель кластера.
- **Модератор:** следит за правилами и безопасностью.
- **Администратор:** управляет контентом, подписками и метриками.

## Пользовательские сценарии
### Регистрация
1. Согласие на обработку данных.
2. Ввод возраста (18+), загрузка 1–3 фото, био до 300 символов.
3. Определение TIM и психософии (вручную или через тест).
4. Опционально: город, часовой пояс, интересы (теги).

### Тестирование
- Две версии тестов: короткая (3–5 минут) и полная (15–20 минут).
- Результаты содержат вероятность и предложение подтвердить тип.

### Профиль
- Поля: возраст, фото, TIM, психософия, гео, интересы.
- Изменение TIM запускает пересчёт совместимости.

### Поиск кластеров
- Фильтры: язык, возраст, гео, активность.
- Балл совместимости (0–100) с объяснением факторов.

### Подача заявки
- Бесплатно: можно подавать заявки в рекомендованные кластеры.
- Платно («вписка»): подача заявки в любой кластер.
- После оплаты слот резервируется на 5 минут.

### Голосование
- Условия принятия: минимум один голос «За» и ни одного «Против».
- Срок голосования: 24 часа, ускоренное принятие при всех «За».
- Кулдаун 48 часов при отказе.

### Жизненный цикл кластера
- Состояния: `forming` (1–3 участника), `active` (4 участника), `rebuild` (пересборка), `suspended` (модерация), `archived`.
- При изменении TIM любого участника запускается голосование о пересборке.

### Чаты
- Реализуются через Telegram-супергруппу с топиками.
- Каждый кластер — отдельный топик с закреплёнными правилами.

### Подписка и монетизация
- **Free:** ограниченный доступ после триала.
- **Member:** полный функционал.
- **Pro:** повышенные лимиты и аналитика.
- Триал 7 дней, затем авто-даунгрейд.
- Оплата через YooKassa, Stripe или Telegram.

### Безопасность и модерация
- Политика 18+.
- Жалобы, предупреждения, баны.
- Автомодерация токсичности.
- Система Trust Score (репутация).

## Модель совместимости
Формула скоринга:

```
S = 50·SocionicsMatch + 20·PsychoMatch + 10·AgeProximity + 8·GeoProximity + 6·ActivityScore + 6·Reputation
```

- **Соционика:** учитывает классические квадры (Альфа–Дельта).
- **Психософия:** совпадение ведущих функций.
- **Возраст:** максимум баллов при разнице ±5 лет.
- **Гео:** совпадение города или часового пояса.
- **Активность:** частота взаимодействий.
- **Репутация:** жалобы и уровень вовлечённости.

## Архитектура и стек
- **Bot Gateway:** aiogram 3.x (Telegram Bot API).
- **Core API:** FastAPI (бизнес-логика, права, REST).
- **Matchmaker Worker:** APScheduler или Celery (поиск и скоринг).
- **Payments Service:** Stripe/YooKassa с идемпотентностью.
- **PostgreSQL:** основная БД.
- **Redis:** кэш и очереди.
- **S3/MinIO:** хранилище фото и логов.

## Безопасность и соответствие
- Соответствие GDPR и ФЗ-152.
- Шифрование PII на хранении и в передаче.
- Геолокация фиксируется на уровне города.
- Экспорт и удаление данных в течение 30 дней.
- Ежедневные бэкапы, RPO ≤24 ч, RTO ≤8 ч.

## Метрики и аналитика
- Основные показатели: TTCF (время до вступления), Retention 7/30, среднее число сообщений на пользователя в неделю, средний балл совместимости кластеров.
- Инструменты: Prometheus + Grafana, Sentry для ошибок, OpenTelemetry для трассировки.

## Trust & Safety
- Политика сообщества и кодекс поведения в каждом чате.
- Жалобы обрабатываются в течение 48 часов.
- Система доверия влияет на выдачу.

## Дорожная карта
- **M0 (1 месяц):** регистрация, профили, тесты, поиск, базовый скоринг.
- **M1 (2–3 месяц):** голосования, чаты (топики), платёжка, триал.
- **M2 (4–5 месяц):** модерация, аналитика, рейтинг, Trust Score.
- **M3 (6 месяц):** Pro-подписка, обучение, публичные кластеры.

## Локальный запуск Core API
1. Создайте и активируйте виртуальное окружение Python 3.11+.
2. Установите зависимости проекта:
   ```bash
   pip install -e .
   ```
3. Запустите FastAPI-приложение:
   ```bash
   uvicorn quadral_cluster.main:app --reload
   ```

4. Основные эндпоинты Core API:
   - `POST /users` — регистрация пользователя и профиля.
   - `PATCH /users/{user_id}/profile` — обновление профиля и типов.
   - `GET /clusters/search` — поиск кластеров по языку, городу, активности и возрастному соответствию.
   - `GET /matchmaking/recommendations` — рекомендации с расшифровкой вкладов в совместимость.
   - `POST /applications` — подача заявки с расчётом совместимости.
5. Откройте Swagger UI по адресу `http://127.0.0.1:8000/docs` для тестирования ручек регистрации, кластеров и матчмейкинга.

## Структура исходного кода
- `src/quadral_cluster/main.py` — точка входа FastAPI Core API.
- `src/quadral_cluster/api/routes.py` — REST-ручки для пользователей, кластеров, заявок и тестов.
- `src/quadral_cluster/models/domain.py` — ORM-модели SQLAlchemy.
- `src/quadral_cluster/services/matchmaking.py` — реализация формулы совместимости.
- `src/quadral_cluster/schemas.py` — Pydantic-схемы запросов и ответов.
- `src/quadral_cluster/config.py` и `database.py` — конфигурация и подключение к БД.
